<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Chat</title>
    <style>
        /* LOCK LAYOUT (No Scrollbars) */
        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; position: fixed; background: #212121;
            font-family: -apple-system, sans-serif; color: #ececec;
            display: flex; flex-direction: column;
        }

        /* SCROLLABLE CHAT */
        #chat-container {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 15px;
            scroll-behavior: smooth;
        }

        .message {
            padding: 12px 18px; border-radius: 18px; max-width: 85%;
            line-height: 1.4; word-wrap: break-word; animation: popIn 0.2s ease;
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .user { background: #0b93f6; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .ai { background: #333; color: #ececec; align-self: flex-start; border-bottom-left-radius: 4px; }

        /* CONTROLS */
        #controls {
            background: #1a1a1a; padding: 20px; padding-bottom: max(20px, env(safe-area-inset-bottom));
            display: flex; flex-direction: column; align-items: center; border-top: 1px solid #333;
        }
        
        #record-btn {
            width: 75px; height: 75px; border-radius: 50%; border: 4px solid #2a2a2a;
            background: #ff453a; color: white; font-weight: 700; font-size: 14px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: all 0.1s; display: flex; align-items: center; justify-content: center;
        }
        #record-btn.recording { transform: scale(0.9); background: #ff9a9e; border-color: #fff; }
        #status { height: 20px; margin-bottom: 10px; font-size: 13px; color: #888; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div id="chat-container">
        <div style="text-align:center; color:#555; margin-top:50px">Ready</div>
    </div>

    <div id="controls">
        <div id="status">HOLD TO SPEAK</div>
        <button id="record-btn">MIC</button>
    </div>

    <script>
        const btn = document.getElementById('record-btn');
        const chat = document.getElementById('chat-container');
        const status = document.getElementById('status');
        
        let mediaRecorder;
        let audioChunks = [];

        // 1. SETUP MIC
        navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = processAudio;
        }).catch(e => {
            status.innerText = "MIC ERROR";
            alert("Mic Access Denied. Ensure you are using HTTPS.");
        });

        // 2. EVENTS
        const start = (e) => { e.preventDefault(); if(mediaRecorder?.state === 'inactive') { audioChunks=[]; mediaRecorder.start(); btn.classList.add('recording'); status.innerText="LISTENING..."; } };
        const stop = (e) => { e.preventDefault(); if(mediaRecorder?.state === 'recording') { mediaRecorder.stop(); btn.classList.remove('recording'); status.innerText="PROCESSING..."; } };

        btn.addEventListener('touchstart', start);
        btn.addEventListener('touchend', stop);
        btn.addEventListener('mousedown', start);
        btn.addEventListener('mouseup', stop);

        // 3. LOGIC
        async function processAudio() {
            const blob = new Blob(audioChunks, { type: 'audio/wav' });
            const formData = new FormData();
            formData.append('audio', blob);

            try {
                // Step A: Transcribe
                status.innerText = "TRANSCRIBING...";
                const res1 = await fetch('/transcribe', { method: 'POST', body: formData });
                const data1 = await res1.json();
                
                if (!data1.text) { status.innerText = "SILENCE DETECTED"; return; }
                addMessage(data1.text, 'user');

                // Step B: Chat + Audio Generation
                status.innerText = "THINKING...";
                const res2 = await fetch('/chat', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: data1.text })
                });
                const data2 = await res2.json();

                // Step C: Display & Play
                addMessage(data2.response, 'ai');
                if (data2.audio_url) {
                    status.innerText = "SPEAKING...";
                    const audio = new Audio(data2.audio_url);
                    audio.play();
                    audio.onended = () => { status.innerText = "READY"; };
                } else {
                    status.innerText = "READY";
                }

            } catch (err) {
                addMessage("Error: " + err.message, 'ai');
                status.innerText = "ERROR";
            }
        }

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerText = text;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }
    </script>
</body>
</html>